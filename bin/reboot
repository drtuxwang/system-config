#!/usr/bin/env bash

set -u

MYHNAME=`uname -n | tr '[A-Z]' '[a-z]' | cut -f1 -d"."`
MYUNAME=$(id -un)

if [ "$MYUNAME" != root ]
then
    echo "Run \"reboot\" as root to restart \"$MYHNAME\""
    exit 1
fi

case $(cat /proc/ide/hd?/model /proc/scsi/scsi /proc/bus/input/devices 2> /dev/null; /sbin/lsmod 2> /dev/null) in
*Hyper-V*|*hv_*)
    TYPE="Hyper-V"
    ;;
*qemu*|*QEMU*)
    TYPE="QEMU"
    ;;
*VBOX*|*vboxguest*)
    TYPE="VirtualBox"
    ;;
*VM[Ww]are*|*vmw_*)
    TYPE="VMware"
    ;;
*xen_blkfront*)
    TYPE="Xen"
    ;;
*)
    echo -e "\n$MYHNAME: Do you really want to reboot system (y/n)?"
    read LINE
    [ "$LINE" != y ] && exit 1
    TYPE="physical"
    ;;
esac
echo "$MYHNAME: reboot $TYPE system..."
sleep 1

/sbin/reboot &
sleep 8

# Sync all mounted filesystems
echo s > /proc/sysrq-trigger 2> /dev/null
sleep 1

# Unmount filesystems and remount in read-only mode
echo u > /proc/sysrq-trigger 2> /dev/null
sleep 0.25

# Restart the system
echo b > /proc/sysrq-trigger 2> /dev/null
